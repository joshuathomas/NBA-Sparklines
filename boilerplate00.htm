<!DOCTYPE html>
<html>
    <head>
        <script src="plotly_02_01_2020.min.js"></script>
        <script src="jquery-3.4.1.min.js"></script>
        <script src="jsonQ.min.js"></script>
        <!--
        
        -->

    </head>
    <style>
        .lf{
            float: left;
        }
    </style>
    <body>
        <!-- this should be the smaller version -->
        <div id="game_info"></div>
        <div>
            <div id="gameQ1" class="lf" style="width:300px;height:600px;"></div>
            <div id="gameQ2" class="lf" style="width:300px;height:600px;"></div>
            <div id="gameQ3" class="lf" style="width:300px;height:600px;"></div>
            <div id="gameQ4" class="lf" style="width:300px;height:600px;"></div>
        </div>

    </body>

    <script>
        //
        // https://stackoverflow.com/questions/10893613/how-can-i-convert-time-to-decimal-number-in-javascript
        //
        function timeStringToFloat(time)
        {
            var minSecTenths = time.split(/[.:]/);
            var min = parseInt(minSecTenths[0], 10);
            var sec = parseInt(minSecTenths[1], 10);
            var tenths = minSecTenths[2] ? parseInt(minSecTenths[1], 10) : 0;
            
            //you only want to go to 4 decimal places
            return (min + ( sec / 60 ) + ( tenths / 600 )).toFixed(4);
        }// end timeStringToFloat

        //
        //
        //
        function printOutQuarterScore(qScore, boxScore)
        {
            var qCurrentScore = qScore[0].plays;
            var xVal = new Array();
            var yVal = new Array();
            
            qCurrentScore.forEach(function(value, index){
                //make the number negative - the values you receive are counting down to 0
                xVal.push(-timeStringToFloat(value.clock));

                if(value.leadTeamId == boxScore.basicGameData.hTeam.teamId){
                    //additionally, the home team's lead will push downwards on the graph 
                    yVal.push(parseInt("-" + value.points));
                }
                else{
                    yVal.push(parseInt(value.points));
                }
            });
            return [xVal, yVal];

        }//end printOutQuarterScore



        var requestDate = "20200131";

        fetch("./nba_json_data/scoreboard_" + requestDate + ".json",
        {
            method: 'GET', // *GET, POST, PUT, DELETE, etc.
            mode: 'cors', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'omit', // include, *same-origin, omit
            headers: { 'Content-Type': 'application/json' // 'Content-Type': 'application/x-www-form-urlencoded'
            }
        })
        .then(response => response.json())
        .then(
            function(response)
            {
                //data => console.log(data)
                var todaysGames = jsonQ(response);
                //to find all the name
                var gameIds = todaysGames.find('gameId');

                //now we're going to branch out and make the other requests

            gameIds.each(
                function (index, path, value) {

                    //just so we're not printing them all out
                    if(index == 5){

                        var gameBoxScore;

                        var gameBoxScoreRequest = $.ajax("./nba_json_data/" + value + "_boxscore.json", {}).done(function(data){});

                        gameBoxScoreRequest.then(function(data){

                            gameBoxScore = data;
                            
                            // ---------------------------------------------------------------
                            // 
                            // ---------------------------------------------------------------
                            var q1Request = $.ajax("./nba_json_data/" + value + "_lead_tracker_1.json").done(function(data){});
                            var q2Request = $.ajax("./nba_json_data/" + value + "_lead_tracker_2.json").done(function(data){});
                            var q3Request = $.ajax("./nba_json_data/" + value + "_lead_tracker_3.json").done(function(data){});
                            var q4Request = $.ajax("./nba_json_data/" + value + "_lead_tracker_4.json").done(function(data){});
                            // ---------------------------------------------------------------
                            // 
                            // ---------------------------------------------------------------
                        
                        
                            $.when(q1Request, q2Request, q3Request, q4Request)
                            .done(                           
                                function(q1Obj, q2Obj, q3Obj, q4Obj){
                                    /*
                                    console.log(
                                        //gameBoxScore.basicGameData.hTeam.teamId
                                        gameBoxScore.basicGameData.vTeam.triCode + " (" + gameBoxScore.basicGameData.vTeam.win + "-" +
                                        gameBoxScore.basicGameData.vTeam.loss + ") " + gameBoxScore.basicGameData.vTeam.score
                                        + " at " +
                                        //gameBoxScore.basicGameData.hTeam.teamId
                                        gameBoxScore.basicGameData.hTeam.triCode + " (" + gameBoxScore.basicGameData.hTeam.win + "-" +
                                        gameBoxScore.basicGameData.hTeam.loss + ") " + gameBoxScore.basicGameData.hTeam.score
                                    );
                                    console.log("---------------------------------------------");
                                    */
                                    //console.log("Q1 -----------------------------");
                                    var q1XY = printOutQuarterScore(q1Obj, gameBoxScore);
                                    //console.log("Q2 -----------------------------");
                                    var q2XY = printOutQuarterScore(q2Obj, gameBoxScore);
                                    //console.log("Q3 -----------------------------");
                                    var q3XY = printOutQuarterScore(q3Obj, gameBoxScore);
                                    //console.log("Q4 -----------------------------");
                                    var q4XY = printOutQuarterScore(q4Obj, gameBoxScore);

                                    //I forgot all about overtime!!!!!!!!!!!


                                    GAMEDIVQ1 = document.getElementById('gameQ1');
                                    GAMEDIVQ2 = document.getElementById('gameQ2');
                                    GAMEDIVQ3 = document.getElementById('gameQ3');
                                    GAMEDIVQ4 = document.getElementById('gameQ4');

                                    var layout = {
                        
                                        xaxis: {
                                            range: [-12, 0],
                                            zeroline: false,
                                            showgrid: false
                                        },
                                        yaxis: {
                                            range: [-25, 25],
                                            showticklabels: false,
                                            type: "linear", //  "-" | "linear" | "log" | "date" | "category" | "multicategory"
                                            autorange: false,
                                            dtick: 5,                                        
                                            zerolinewidth: 4,
                                            autotick: false,
                                            showgrid: true
                                        }
                                    };
                                    //console.log(q1XY[0]);
                                    //console.log(q1XY[1]);

                                    Plotly.newPlot( GAMEDIVQ1, [{
                                        x: q1XY[0],
                                        y: q1XY[1] }], layout );

                                    Plotly.newPlot( GAMEDIVQ2, [{
                                        x: q2XY[0],
                                        y: q2XY[1] }], layout );
                                    
                                    Plotly.newPlot( GAMEDIVQ3, [{
                                        x: q3XY[0],
                                        y: q3XY[1] }], layout );

                                    Plotly.newPlot( GAMEDIVQ4, [{
                                        x: q4XY[0],
                                        y: q4XY[1] }], layout );
                                    
                                $('#game_info').text(
                                    gameBoxScore.basicGameData.vTeam.triCode + " (" + gameBoxScore.basicGameData.vTeam.win + "-" +
                                    gameBoxScore.basicGameData.vTeam.loss + ") " + gameBoxScore.basicGameData.vTeam.score
                                    + " at " +
                                    //gameBoxScore.basicGameData.hTeam.teamId
                                    gameBoxScore.basicGameData.hTeam.triCode + " (" + gameBoxScore.basicGameData.hTeam.win + "-" +
                                    gameBoxScore.basicGameData.hTeam.loss + ") " + gameBoxScore.basicGameData.hTeam.score
                                );

                            });//end when request for each quarter
                        });//gameBoxScoreRequest then finished
                    }//end if statement for index
            });//end gameIds each function

            //to print list of all games
            //console.log(gameIds.value());

        
        });//end fetch response
        
        


    </script>
    
</html>